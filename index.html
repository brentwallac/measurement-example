<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Freight Calculator: Buy Rate (W/M) & Margin Rate (Multiple Methods)</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

<div class="max-w-7xl mx-auto p-4 md:p-8">

  <!-- Title -->
  <h2 class="text-3xl md:text-4xl font-bold text-center mb-8">
    Freight Buy Rate Calculator
    <br/>
    <span class="text-lg">
      Buy Rate = W/M; Margin Rate = Selected Rule
    </span>
  </h2>

  <!-- Tab Buttons -->
  <div class="flex space-x-4 justify-center mb-6">
    <button
      class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded"
      onclick="showTab('calculatorTab')"
    >
      Calculator
    </button>
    <button
      class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded"
      onclick="showTab('devCheatSheetTab')"
    >
      Developer Cheat Sheet
    </button>
  </div>

  <!-- CALCULATOR TAB -->
  <div id="calculatorTab" class="tabContent">

    <!-- Grid Layout -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

      <!-- Left Column: Inputs -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold mb-4">Enter Shipment Details</h3>

        <!-- Freight Type -->
        <label class="block font-medium mb-1">Freight Type:</label>
        <select id="freightType" class="w-full p-2 border rounded mb-4">
          <option value="lcl">Sea Freight (LCL / Ocean)</option>
          <option value="air">Air Freight</option>
        </select>

        <!-- Dimensions (m) -->
        <label class="block font-medium mb-1">Dimensions (in meters):</label>
        <div class="flex space-x-2 mb-4">
          <input
            type="number"
            id="length"
            step="0.01"
            placeholder="Length (m)"
            class="w-1/3 p-2 border rounded"
          />
          <input
            type="number"
            id="width"
            step="0.01"
            placeholder="Width (m)"
            class="w-1/3 p-2 border rounded"
          />
          <input
            type="number"
            id="height"
            step="0.01"
            placeholder="Height (m)"
            class="w-1/3 p-2 border rounded"
          />
        </div>

        <!-- Weight (kg) -->
        <label class="block font-medium mb-1">Actual Weight (in kilograms):</label>
        <input
          type="number"
          id="weight"
          placeholder="Enter weight (kg)"
          class="w-full p-2 border rounded mb-4"
        />

        <!-- Margin Rule -->
        <label class="block font-medium mb-1">
          Margin Rule (Method):
        </label>
        <select id="marginRule" class="w-full p-2 border rounded mb-4">
          <option value="CW_1_TO_3">Cargo Weight 1 to 3 (1 CBM = 333 kg)</option>
          <option value="CW_1_TO_6">Cargo Weight 1 to 6 (1 CBM = 167 kg)</option>
          <option value="M">Per Cubic Meter (M)</option>
          <option value="W/M">Weight or Measure (W/M)</option>
          <option value="PER_KG">Per KG (actual kilograms)</option>
          <option value="PER_W">Per Weight (metric tons)</option>
          <option value="PER_M">Per Measure (CBM)</option>
        </select>

        <!-- Buy Rate & Margin Rate -->
        <label class="block font-medium mb-1">
          Buy Rate (USD per W/M unit):
        </label>
        <input
          type="number"
          id="buyRate"
          placeholder="Enter buy rate"
          class="w-full p-2 border rounded mb-4"
        />

        <label class="block font-medium mb-1">
          Margin Rate (USD per selected rule):
        </label>
        <input
          type="number"
          id="marginRate"
          placeholder="Enter margin rate"
          class="w-full p-2 border rounded mb-4"
        />

        <!-- Calculate Button -->
        <button
          onclick="calculateFreightCost()"
          class="w-full bg-blue-600 text-white p-2 rounded font-medium hover:bg-blue-700"
        >
          Calculate
        </button>
      </div>

      <!-- Middle Column: Calculation Breakdown -->
      <div class="bg-gray-50 p-6 rounded-lg shadow-md md:col-span-1 lg:col-span-2">
        <h3 class="text-xl font-semibold mb-4">Calculation Breakdown</h3>
        <pre
          id="calculationBreakdown"
          class="text-sm bg-gray-200 p-4 rounded whitespace-pre-wrap mb-4"
        ></pre>

        <!-- ELI5 Button & Explanation -->
        <button
          id="eli5Btn"
          class="bg-green-600 hover:bg-green-700 text-white font-medium px-3 py-2 rounded mb-2"
          onclick="toggleELI5()"
        >
          Show Simple Explanation
        </button>
        <pre
          id="ELI5Explanation"
          class="text-sm bg-green-100 p-3 rounded whitespace-pre-wrap hidden"
        ></pre>
      </div>

      <!-- Right Column: Results -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-xl font-semibold mb-4">Results</h3>

        <p>
          <strong title="Units used for the Buy Rate: W/M approach." class="cursor-help">
            Buy Rate Units (W/M):
          </strong>
          <span id="buyUnitsDisplay">0</span>
        </p>

        <p>
          <strong title="Units used for the Margin cost, based on the selected rule." class="cursor-help">
            Margin Units:
          </strong>
          <span id="marginUnitsDisplay">0</span>
        </p>

        <hr class="my-2"/>

        <p>
          <strong>Provider Buy Rate Cost:</strong>
          <span id="buyRateCost">$0</span>
        </p>
        <p>
          <strong>Your Margin Cost:</strong>
          <span id="marginCost">$0</span>
        </p>

        <p class="font-semibold text-lg mt-2">
          <strong>Total Freight Cost:</strong> 
          <span id="totalCost">$0</span>
        </p>
      </div>
    </div>
  </div> <!-- End calculatorTab -->

  <!-- DEVELOPER CHEAT SHEET TAB -->
  <div id="devCheatSheetTab" class="tabContent hidden bg-white p-6 rounded-lg shadow-md">
    <h3 class="text-2xl font-semibold mb-4">Developer Cheat Sheet</h3>

    <p class="mb-4">
      This page explains the core formulas used throughout the calculator.
    </p>

    <ol class="list-decimal list-inside space-y-4 text-sm">
      <li>
        <strong>Cubic Meters (CBM)</strong><br/>
        Formula: <code>CBM = Length (m) × Width (m) × Height (m)</code><br/>
        Example: if Length=2.0, Width=1.5, Height=1.0 (all in meters), then 
        CBM = <code>2.0 × 1.5 × 1.0 = 3.0</code>.
      </li>

      <li>
        <strong>Metric Tons (MT)</strong><br/>
        Formula: <code>Weight (kg) ÷ 1000</code><br/>
        Example: if the cargo weighs 1500 kg, that’s 
        <code>1500 ÷ 1000 = 1.5 MT</code>.
      </li>

      <li>
        <strong>Air Freight Volumetric Weight</strong><br/>
        If Freight Type = “Air,” we calculate volumetric weight (in kg) via 
        <code>(Length_cm × Width_cm × Height_cm) ÷ 6000</code>, then convert 
        to metric tons by dividing by 1000. We compare this volumetric value 
        to the actual weight and use whichever is higher for the “weight side.”
      </li>

      <li>
        <strong>Weight or Measure (W/M)</strong><br/>
        Under W/M, compare weight (in MT) vs. volume (in CBM), and pick the 
        larger number as the chargeable unit.
      </li>

      <li>
        <strong>Margin Methods:</strong><br/>
        <ul class="list-disc ml-6">
          <li>
            <strong>CW_1_TO_3</strong> → 1 CBM = 333 kg 
            (so CBM × 333 kg, then compare to actual weight).
          </li>
          <li>
            <strong>CW_1_TO_6</strong> → 1 CBM = 167 kg
            (so CBM × 167 kg, then compare to actual weight).
          </li>
          <li>
            <strong>M (Per Cubic Meter)</strong> → uses only CBM, ignores weight.
          </li>
          <li>
            <strong>W/M</strong> → standard “Weight or Measure” comparison.
          </li>
          <li>
            <strong>PER_KG</strong> → purely actual weight in kilograms.
          </li>
          <li>
            <strong>PER_W (metric tons)</strong> → uses weight in MT, 
            and if Air Freight, may compare with volumetric tons.
          </li>
          <li>
            <strong>PER_M (CBM)</strong> → purely the measured CBM.
          </li>
        </ul>
      </li>

      <li>
        <strong>Total Cost</strong><br/>
        We split costs into “Buy Rate” (always W/M) and “Margin Rate” 
        (the chosen rule). Then:
        <br/>
        <code>
          Buy Rate Cost = (Buy Rate Units) × (Buy Rate)</code><br/>
        <code>
          Margin Cost = (Margin Units) × (Margin Rate)</code><br/>
        <code>
          Total Freight Cost = Buy Rate Cost + Margin Cost</code>
      </li>
    </ol>
  </div> <!-- End devCheatSheetTab -->
</div> <!-- End container -->

<script>
  /**
   * Toggle the Simple Explanation (ELI5)
   */
  function toggleELI5() {
    const eli5Box = document.getElementById("ELI5Explanation");
    eli5Box.classList.toggle("hidden");
  }

  /**
   * Show/Hide Tabs
   */
  function showTab(tabId) {
    // Hide all tabContent
    document.querySelectorAll('.tabContent').forEach((el) => {
      el.classList.add('hidden');
    });
    // Show the selected tab
    document.getElementById(tabId).classList.remove('hidden');
  }

  function calculateFreightCost() {
    // Same calculator logic as before
    let breakdownText = "";
    const addLine = (str) => { breakdownText += str + "\n\n"; };

    const length = parseFloat(document.getElementById("length").value);
    const width = parseFloat(document.getElementById("width").value);
    const height = parseFloat(document.getElementById("height").value);
    const weightKG = parseFloat(document.getElementById("weight").value);

    const freightType = document.getElementById("freightType").value;
    const marginRule = document.getElementById("marginRule").value;

    const buyRate = parseFloat(document.getElementById("buyRate").value);
    const marginRate = parseFloat(document.getElementById("marginRate").value);

    if (
      isNaN(length) || isNaN(width) || isNaN(height) ||
      isNaN(weightKG) || isNaN(buyRate) || isNaN(marginRate)
    ) {
      alert("Please fill in all fields with valid numbers.");
      return;
    }

    // 1) Common calculations
    const measureSideCBM = length * width * height;
    const actualWeightTons = weightKG / 1000;

    // =========== BUY RATE (W/M) ============
    addLine("=== BUY RATE: WEIGHT OR MEASURE (W/M) ===");

    let buyWeightSide = actualWeightTons;
    addLine(`Volume (CBM) L * W * H = ${measureSideCBM.toFixed(3)}
Weight (MT) = ${buyWeightSide.toFixed(3)}`);

    // If air, check volumetric
    if (freightType === "air") {
      addLine("Freight Type = Air => check volumetric weight:");
      const lengthCM = length * 100;
      const widthCM = width * 100;
      const heightCM = height * 100;
      const volumeCC = lengthCM * widthCM * heightCM;
      const volumetricKG = volumeCC / 6000;
      const volumetricTons = volumetricKG / 1000;

      addLine(`volumetricKG = (L_cm × W_cm × H_cm) ÷ 6000 = ${volumetricKG.toFixed(2)}
volumetricTons = ${volumetricTons.toFixed(3)}
Compare vs actualWeightTons = ${buyWeightSide.toFixed(3)}`);

      if (volumetricTons > buyWeightSide) {
        buyWeightSide = volumetricTons;
        addLine(`=> using volumetricTons = ${buyWeightSide.toFixed(3)}`);
      } else {
        addLine(`=> keep actualWeightTons = ${buyWeightSide.toFixed(3)}`);
      }
    } else {
      addLine("Not air => skip volumetric check for Buy Rate.");
    }

    addLine(`Compare buyWeightSide (${buyWeightSide.toFixed(3)}) vs measureSideCBM (${measureSideCBM.toFixed(3)})
=> pick whichever is larger for W/M.`);

    const buyRateUnits = Math.max(buyWeightSide, measureSideCBM);
    addLine(`=> buyRateUnits = ${buyRateUnits.toFixed(3)}`);

    const buyRateCost = buyRateUnits * buyRate;
    addLine(`Buy Rate Cost = buyRateUnits × buyRate = ${buyRateUnits.toFixed(3)} × $${buyRate} = $${buyRateCost.toFixed(2)}`);

    // =========== MARGIN RATE (selected rule) =============
    addLine("=== MARGIN RATE: SELECTED RULE ===");

    let marginUnits = 0;

    function applyAirVolumetric(baseWeightTons) {
      if (freightType === "air") {
        addLine("Check volumetric for margin side as well:");
        const lengthCM = length * 100;
        const widthCM = width * 100;
        const heightCM = height * 100;
        const volumeCC = lengthCM * widthCM * heightCM;
        const volumetricKG = volumeCC / 6000;
        const volumetricTons = volumetricKG / 1000;

        addLine(`volumetricTons = ${volumetricTons.toFixed(3)}
Compare vs baseWeightTons = ${baseWeightTons.toFixed(3)}`);
        if (volumetricTons > baseWeightTons) {
          addLine(`=> using volumetricTons = ${volumetricTons.toFixed(3)}`);
          return volumetricTons;
        } else {
          addLine(`=> keep baseWeightTons = ${baseWeightTons.toFixed(3)}`);
          return baseWeightTons;
        }
      } else {
        addLine("Not air => skip volumetric for margin side.");
        return baseWeightTons;
      }
    }

    switch (marginRule) {
      case "CW_1_TO_3": {
        addLine("Rule: 1 CBM = 333 kg => ratio-based weight vs actual weight, then compare to CBM");
        const ratioWeightTons = (measureSideCBM * 333) / 1000;
        addLine(`ratioWeightTons = (CBM × 333) ÷ 1000
= ${ratioWeightTons.toFixed(3)} MT
Compare vs actualWeightTons = ${actualWeightTons.toFixed(3)}`);
        let weightSide = Math.max(ratioWeightTons, actualWeightTons);
        addLine(`=> weightSide = ${weightSide.toFixed(3)} MT (larger of ratio/actual)`);
        weightSide = applyAirVolumetric(weightSide);
        marginUnits = Math.max(weightSide, measureSideCBM);
        addLine(`=> marginUnits = max(${weightSide.toFixed(3)}, ${measureSideCBM.toFixed(3)}) = ${marginUnits.toFixed(3)}`);
        break;
      }

      case "CW_1_TO_6": {
        addLine("Rule: 1 CBM = 167 kg => ratio-based weight vs actual weight, then compare to CBM");
        const ratioWeightTons = (measureSideCBM * 167) / 1000;
        addLine(`ratioWeightTons = (CBM × 167) ÷ 1000
= ${ratioWeightTons.toFixed(3)} MT`);
        let weightSide = Math.max(ratioWeightTons, actualWeightTons);
        addLine(`=> weightSide = ${weightSide.toFixed(3)} MT`);
        weightSide = applyAirVolumetric(weightSide);
        marginUnits = Math.max(weightSide, measureSideCBM);
        addLine(`=> marginUnits = ${marginUnits.toFixed(3)}`);
        break;
      }

      case "M": {
        addLine("Rule: Per Cubic Meter => purely CBM");
        marginUnits = measureSideCBM;
        addLine(`=> marginUnits = ${marginUnits.toFixed(3)}`);
        break;
      }

      case "W/M": {
        addLine("Rule: Weight or Measure => compare weight side vs volume for margin");
        let wSide = applyAirVolumetric(actualWeightTons);
        marginUnits = Math.max(wSide, measureSideCBM);
        addLine(`=> marginUnits = max(${wSide.toFixed(3)}, ${measureSideCBM.toFixed(3)}) = ${marginUnits.toFixed(3)}`);
        break;
      }

      case "PER_KG": {
        addLine("Rule: Per KG => purely actual kg (no volume check).");
        marginUnits = weightKG;
        addLine(`=> marginUnits = ${marginUnits} kg`);
        break;
      }

      case "PER_W": {
        addLine("Rule: Per Weight => purely MT, possibly air volumetric if bigger.");
        let wTons = applyAirVolumetric(actualWeightTons);
        marginUnits = wTons;
        addLine(`=> marginUnits = ${marginUnits.toFixed(3)} MT`);
        break;
      }

      case "PER_M": {
        addLine("Rule: Per Measure => purely CBM, ignoring weight.");
        marginUnits = measureSideCBM;
        addLine(`=> marginUnits = ${marginUnits.toFixed(3)} m³`);
        break;
      }
    }

    const marginCost = marginUnits * marginRate;
    addLine(`Margin Cost = marginUnits × marginRate
= ${marginUnits.toFixed(3)} × $${marginRate} 
= $${marginCost.toFixed(2)}`);

    const totalCost = buyRateCost + marginCost;
    addLine("=== FINAL TOTAL ===");
    addLine(`Buy Rate Cost = $${buyRateCost.toFixed(2)}
Margin Cost  = $${marginCost.toFixed(2)}
Total        = $${totalCost.toFixed(2)}`);

    // ELI5
    const simplifiedText = `
1) Buy Rate uses W/M (weight in MT vs. CBM). If Air, also check volumetric weight.
2) Margin Rate uses the selected rule: ratio-based, pure CBM, pure KG, or W/M, etc.
3) Total = Buy Rate Cost + Margin Cost.
    `.trim();

    // Update the UI
    document.getElementById("calculationBreakdown").textContent = breakdownText.trim();
    document.getElementById("ELI5Explanation").textContent = simplifiedText;
    document.getElementById("ELI5Explanation").classList.add("hidden");

    document.getElementById("buyUnitsDisplay").textContent = buyRateUnits.toFixed(3);
    document.getElementById("marginUnitsDisplay").textContent = marginUnits.toFixed(3);
    document.getElementById("buyRateCost").textContent = `$${buyRateCost.toFixed(2)}`;
    document.getElementById("marginCost").textContent = `$${marginCost.toFixed(2)}`;
    document.getElementById("totalCost").textContent = `$${totalCost.toFixed(2)}`;
  }
</script>

</body>
</html>
